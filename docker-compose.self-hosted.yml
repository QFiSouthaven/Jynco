# Docker Compose Override for SELF-HOSTED PRODUCTION Mode
# Usage: docker-compose -f docker-compose.yml -f docker-compose.self-hosted.yml up -d
#
# SELF-HOSTED PRODUCTION MODE:
# - gVisor runtime installed (recommended)
# - Vault optional but recommended
# - S3 optional (can use local storage)
# - IAM optional (can use basic auth)
# - Controlled egress via proxy (optional)

version: '3.8'

services:
  # Backend API Gateway - Self-Hosted Configuration
  backend:
    environment:
      # Execution Mode
      JYNCO_EXECUTION_MODE: self-hosted-production

      # Secrets Management (RECOMMENDED)
      VAULT_ADDR: ${VAULT_ADDR:-}  # Optional
      VAULT_TOKEN: ${VAULT_TOKEN:-}
      VAULT_NAMESPACE: ${VAULT_NAMESPACE:-videofoundry}

      # Authentication/IAM (RECOMMENDED)
      OIDC_PROVIDER_URL: ${OIDC_PROVIDER_URL:-}  # Optional, can use basic auth
      OIDC_CLIENT_ID: ${OIDC_CLIENT_ID:-}
      OIDC_CLIENT_SECRET: ${OIDC_CLIENT_SECRET:-}
      ENABLE_IAM: ${ENABLE_IAM:-true}

      # Storage (S3 recommended, local allowed)
      S3_BUCKET: ${S3_BUCKET:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      USE_S3_STORAGE: ${USE_S3_STORAGE:-false}
      LOCAL_STORAGE_PATH: /videos

      # Security
      ENABLE_WORKFLOW_VETTING: "true"
      ENABLE_NETWORK_ISOLATION: ${ENABLE_NETWORK_ISOLATION:-false}
      WORKFLOW_ALLOWLIST_PATH: /config/workflow_allowlist.yaml

      # Egress Control
      EGRESS_PROXY_URL: ${EGRESS_PROXY_URL:-}
      EGRESS_ALLOWLIST: ${EGRESS_ALLOWLIST:-}

      # Application
      ENVIRONMENT: self-hosted-production
      DEBUG: "false"

    volumes:
      - ./config/workflow_allowlist.yaml:/config/workflow_allowlist.yaml:ro
      - local_videos:/videos  # Local storage fallback

    # Security hardening (less strict than production)
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

  # AI Worker Service - Self-Hosted Configuration
  ai_worker:
    runtime: ${DOCKER_RUNTIME:-runsc}  # Default to gVisor, can override

    environment:
      JYNCO_EXECUTION_MODE: self-hosted-production
      VAULT_ADDR: ${VAULT_ADDR:-}
      VAULT_TOKEN: ${VAULT_TOKEN:-}
      S3_BUCKET: ${S3_BUCKET:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      ENABLE_WORKFLOW_VETTING: "true"

      # Proxy configuration for controlled egress
      HTTP_PROXY: ${EGRESS_PROXY_URL:-}
      HTTPS_PROXY: ${EGRESS_PROXY_URL:-}
      NO_PROXY: "postgres,redis,rabbitmq,backend,comfyui"

    volumes:
      - ./config/workflow_allowlist.yaml:/config/workflow_allowlist.yaml:ro
      - worker_temp:/tmp/worker
      - local_videos:/videos

    # Sandboxing
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Network configuration (can access internet via proxy if configured)
    networks:
      - default

  # Composition Worker - Self-Hosted Configuration
  composition_worker:
    runtime: ${DOCKER_RUNTIME:-runsc}

    environment:
      JYNCO_EXECUTION_MODE: self-hosted-production
      S3_BUCKET: ${S3_BUCKET:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}

    volumes:
      - composition_temp:/tmp/composition
      - local_videos:/videos

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ComfyUI Service - Self-Hosted Configuration
  comfyui:
    runtime: ${DOCKER_RUNTIME:-runsc}

    environment:
      CLI_ARGS: --listen 0.0.0.0 --port 8188
      HTTP_PROXY: ${EGRESS_PROXY_URL:-}
      HTTPS_PROXY: ${EGRESS_PROXY_URL:-}

    volumes:
      - comfyui_models:/app/models
      - comfyui_output:/app/output
      - comfyui_input:/app/input
      - local_videos:/videos

    security_opt:
      - no-new-privileges:true

    # GPU access
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # Egress Proxy (Optional - for controlled internet access)
  egress_proxy:
    image: sameersbn/squid:latest
    container_name: vf_egress_proxy
    profiles:
      - egress-control  # Only start if needed
    volumes:
      - ./config/squid.conf:/etc/squid/squid.conf:ro
      - ./logs/squid:/var/log/squid
    ports:
      - "127.0.0.1:3128:3128"  # Only accessible from host
    networks:
      - default
    security_opt:
      - no-new-privileges:true

  # PostgreSQL - Basic security
  postgres:
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}  # Change in production!

    # Optional: Expose for admin access
    ports:
      - "${POSTGRES_PORT:-54321}:5432"

    security_opt:
      - no-new-privileges:true

  # Redis
  redis:
    command: >
      redis-server
      --requirepass "${REDIS_PASSWORD:-}"
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

    security_opt:
      - no-new-privileges:true

  # RabbitMQ
  rabbitmq:
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}

    security_opt:
      - no-new-privileges:true

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${FRONTEND_API_URL:-http://localhost:8000}

    environment:
      - NODE_ENV=production
      - VITE_EXECUTION_MODE=self-hosted-production

    security_opt:
      - no-new-privileges:true

  # Portainer - Enabled for admin convenience
  portainer:
    profiles:
      - default

# Volumes
volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  worker_temp:
  composition_temp:
  comfyui_models:
  comfyui_output:
  comfyui_input:
  local_videos:
  portainer_data:
