# Squid Proxy Configuration for Video Foundry
# Self-Hosted Production Mode - Egress Control
#
# This proxy allows administrators to control which external resources
# AI workers can access for downloading custom nodes and models.

# Network Configuration
http_port 3128

# Access Control Lists (ACLs)

# Define allowed domains (ADMIN: Customize this list)
acl allowed_domains dstdomain .github.com
acl allowed_domains dstdomain .githubusercontent.com
acl allowed_domains dstdomain .huggingface.co
acl allowed_domains dstdomain .civitai.com
# Add more approved domains as needed:
# acl allowed_domains dstdomain .your-internal-registry.com

# Define blocked domains (optional - for extra security)
acl blocked_domains dstdomain .malicious-site.com
# Add known malicious domains here

# SSL ports
acl SSL_ports port 443

# Safe ports
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 21          # ftp
acl Safe_ports port 8080        # http-alt

# HTTP methods
acl CONNECT method CONNECT

# Access Rules

# Deny requests to dangerous ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Deny blocked domains explicitly
http_access deny blocked_domains

# Allow access to approved domains
http_access allow allowed_domains

# Deny all other requests
http_access deny all

# Logging Configuration

# Access log (all requests)
access_log /var/log/squid/access.log squid

# Cache log
cache_log /var/log/squid/cache.log

# Custom log format for security auditing
logformat security_audit %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt
access_log /var/log/squid/security.log security_audit

# Cache Configuration

# Disable caching for security (always fetch fresh)
cache deny all

# Or enable limited caching for performance (optional):
# cache_mem 256 MB
# maximum_object_size 100 MB
# cache_dir ufs /var/spool/squid 10000 16 256

# Security Headers

# Remove server identification
httpd_suppress_version_string on

# Request timeout
request_timeout 5 minutes

# Connection timeout
connect_timeout 1 minute

# Admin email (customize)
cache_mgr admin@videofoundry.local

# Hostname
visible_hostname videofoundry-egress-proxy

# Error pages
error_directory /usr/share/squid/errors/en

# Performance Tuning

# Maximum connections
http_accel_max_connections 100

# DNS Configuration

# Use system DNS
dns_nameservers 8.8.8.8 8.8.4.4

# DNS timeout
dns_timeout 30 seconds

# Miscellaneous

# Don't forward Host header
forwarded_for delete

# Don't reveal internal IP structure
via off

# Refresh patterns (if caching enabled)
# refresh_pattern ^ftp:           1440    20%     10080
# refresh_pattern ^gopher:        1440    0%      1440
# refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
# refresh_pattern .               0       20%     4320
